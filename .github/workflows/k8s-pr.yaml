name: K8S Linting
on:
  pull_request:
    branches:
      - main
    paths:
      - infra/k8s/**

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v2
      # - name: Lint Code Base
      #   uses: github/super-linter@v4
      #   env:
      #     VALIDATE_ALL_CODEBASE: false
      #     FILTER_REGEX_INCLUDE: .*infra/k8s/.*
      #     DEFAULT_BRANCH: main
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Get changed envs
        id: changed-files
        uses: tj-actions/changed-files@v1.1.3
        with:
          files: |
            infra/k8s/base
            infra/k8s/overlays/dev
            infra/k8s/overlays/uat
            infra/k8s/overlays/demo
            infra/k8s/overlays/live 
      - id: set-matrix
        run: |
          CHANGED_ENVFILES_IN_COMMIT="${{ steps.changed-files.outputs.all_changed_and_modified_files }}"
          echo $CHANGED_ENVFILES_IN_COMMIT
          y=($x)
          changed=()
          for direct in ${y[@]}
          do
            DIR=$(dirname ${direct})
            changed+=(basename ${DIR})
          done
          LIST=${changed[@]}
          echo "LIST $LIST"
          echo "::set-output name=matrix::$LIST"
  test:
    name: Lint
    runs-on: ubuntu-latest    
    needs: lint
    strategy:
      fail-fast: false
      matrix: ${{fromJson(needs.lint.outputs.matrix)}}
    steps:
      - uses: imranismail/setup-kustomize@v1
      - name: kustomize build
        run: |
          ENV=$(echo ${{ matrix.plans }} | cut -f 4 -d '/')
          cd infra/k8s/overlays/$ENV/
          kustomize build .
# todo: add lint step for justomize build, dry runs etc. need to work out env to get correct paths etc
